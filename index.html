<!doctype html>
<html lang="ja">
<head>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="apple-touch-icon" href="icon.png">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>CNC行ごと翻訳 - LITE-v5.1-20250828-002646</title>
  <style>
    :root { --bg:#fff; --fg:#111827; --muted:#6b7280; --border:#e5e7eb; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:-apple-system,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--border);padding:8px 12px;z-index:10}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar select{font:inherit;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    main{display:flex;flex-direction:column;gap:8px;align-items:stretch;padding:8px 12px;max-width:1000px;margin:0 auto}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width: 880px){ .cols{grid-template-columns:1fr} }
    .panel{display:flex;flex-direction:column;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .panel header{display:flex;gap:8px;align-items:center;border:0;border-bottom:1px solid var(--border);padding:6px 10px}
    .panel .body{padding:8px 10px}
    select,button{font:inherit;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{cursor:pointer}
    textarea{width:100%;border:1px solid var(--border);border-radius:8px;padding:10px;
      font-family:ui-monospace,SFMono-Regular,Menlo,monospace;
      font-size:16px; line-height:1.4; height:4.6em;}
    .out{max-height:48vh;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:14px}
    .row{display:flex;border-bottom:1px dashed var(--border)}
    .row:nth-child(even){background:#fafafa}
    .cell{padding:6px 8px;white-space:pre-wrap;word-break:break-all}
    .cell.code{width:50%}
    .cell.tr{width:50%;border-left:1px solid var(--border)}
    .small{color:var(--muted);font-size:12px}
    .unknown{background:#fffbea}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .dictlist{max-height:48vh;overflow:auto;font-size:14px}
    .dictlist table{width:100%;border-collapse:collapse}
    .dictlist th,.dictlist td{border-bottom:1px dashed var(--border);padding:6px 8px;text-align:left;vertical-align:top}
    .dictlist tr:nth-child(even){background:#fafafa}
    .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin:2px 6px 2px 0;font-family:ui-monospace,monospace;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="toolbar">
      <strong>CNC行ごと翻訳</strong>
      <label>メーカー:
        <select id="maker"></select>
      </label>
      <label>機種:
        <select id="model"></select>
      </label>
      <label id="verLabel" style="display:none">バージョン:
        <select id="version"></select>
      </label>
      <label id="ssLabel" style="display:none">サブスピ:
        <select id="subspindle">
          <option value="NoSS">なし</option>
          <option value="SS">あり</option>
        </select>
      </label>
      <span class="small">LITE-v5.1-20250828-002646</span>
    </div>
  </header>

  <main class="cols">
    <section class="panel">
      <header><strong>入力（1行＝1ブロック）</strong></header>
      <div class="body">
        <textarea id="src" placeholder="例）G28U0W0;"></textarea>
        <div class="controls">
          <button id="btnTranslate">翻訳（⌘/Ctrl + Enter）</button>
          <button id="btnClear">クリア</button>
          <span class="small">※ コード間のスペースや；の有無は不問</span>
        </div>
      </div>
    </section>

    <section class="panel">
      <header><strong>この機種で認識するコード</strong> <span class="small">（機種選択毎に自動更新）</span></header>
      <div class="body dictlist" id="dictlist"></div>
    </section>

    <section class="panel" style="grid-column:1 / -1">
      <header><strong>出力（コード名のみ）</strong> <span class="small">未知は<span class="unknown">黄色</span></span></header>
      <div class="body out" id="out"></div>
    </section>
  </main>

  <script>
    const MAKERS = [
      { key:'tsugami', name:'ツガミ', models:[
        { key:'B012',   name:'B012',   versions:['II','III','F'], subspindleOption:false },
        { key:'B018',   name:'B018',   versions:['III'],          subspindleOption:false },
        { key:'B0125',  name:'B0125',  versions:['無印','II','III'], subspindleOption:true },
        { key:'BE',     name:'BE',     versions:['12','20-V'],    subspindleOption:false },
        { key:'BS',     name:'BS',     versions:['12-III','18-III'], subspindleOption:false },
      ]},
      { key:'star', name:'スター精密', models:[
        { key:'RNC-16',   name:'RNC-16',   versions:[], subspindleOption:false },
        { key:'RNC-16-II',name:'RNC-16-II',versions:[], subspindleOption:false },
        { key:'RNC-16B-II',name:'RNC-16B-II',versions:[], subspindleOption:false },
        { key:'SC-20',    name:'SC-20',    versions:[], subspindleOption:false },
      ]},
      { key:'technowasino', name:'テクノワシノ', models:[
        { key:'G05', name:'G05', versions:[], subspindleOption:false },
        { key:'LG-6', name:'LG-6', versions:[], subspindleOption:false },
      ]},
    ];

    const dict_base = {
      "G0":"早送り移動","G00":"早送り移動","G1":"直線補間","G01":"直線補間",
      "G2":"円弧補間CW","G02":"円弧補間CW","G3":"円弧補間CCW","G03":"円弧補間CCW",
      "G4":"ドウェル(一時停止)","G04":"ドウェル(一時停止)","G28":"原点復帰",
      "G94":"送り 毎分","G95":"送り 毎回転","G96":"定切削速度(CSS)","G97":"回転数指定",
      "G98":"固定サイクル 復帰:初期位置","G99":"固定サイクル 復帰:R点",
      "M0":"プログラム一時停止","M00":"プログラム一時停止","M1":"条件付停止","M01":"条件付停止",
      "M2":"プログラム終了","M02":"プログラム終了","M3":"主軸 正転","M03":"主軸 正転",
      "M4":"主軸 逆転","M04":"主軸 逆転","M5":"主軸 停止","M05":"主軸 停止",
      "M8":"クーラント ON","M08":"クーラント ON","M9":"クーラント OFF","M09":"クーラント OFF",
      "M10":"チャック/コレット クランプ（機種依存）",
      "M11":"チャック/コレット アンクランプ（機種依存）",
      "M60":"バーフィーダ制御（機種依存）","M61":"バーフィーダ制御（機種依存）","M62":"バーフィーダ制御（機種依存）",
    };

    const dict_maker = {"tsugami":{}, "star":{}, "technowasino":{}};
    const dict_model = {};
    const dict_option = {"SS":{"M110":"サブ主軸 クランプ（機種依存）","M111":"サブ主軸 アンクランプ（機種依存）"},"NoSS":{}};

    function composeDict(makerKey, modelKey, version, ss){
      const base = {...dict_base};
      const mk   = dict_maker[makerKey] || {};
      const opt  = dict_option[ss] || {};
      const modelId = version ? `${makerKey}:${modelKey}:${version}` : `${makerKey}:${modelKey}`;
      const md   = dict_model[modelId] || {};
      return {...base, ...mk, ...opt, ...md};
    }

    function tokenize(line){
      const commentStripped = line.replace(/\(.*?\)/g, '').trim();
      const cleaned = commentStripped.replace(/;+$/, '');
      const parts = []; let buf = "";
      for (let i=0;i<cleaned.length;i++){ const ch = cleaned[i]; if (ch===' ') { if(buf){parts.push(buf); buf="";} } else { buf+=ch; } }
      if (buf) parts.push(buf);
      const out = [];
      for (const p of parts){
        let cur=""; for (let i=0;i<p.length;i++){ const ch=p[i]; const prev=cur[cur.length-1];
          const isL=/[A-Za-z]/.test(ch); const prevL=/[A-Za-z]/.test(prev||'');
          if (isL && cur && !prevL){ out.push(cur); cur=ch; } else { cur+=ch; }
        }
        if (cur) out.push(cur);
      }
      return out.filter(t=>t.length);
    }

    function translateLine(line, dict){
      const tokens = tokenize(line);
      if (!tokens.length) return ["", false];
      const primary = []; const params = []; let unknowns = [];
      for (const tk of tokens){
        const u = tk.toUpperCase();
        if (/^G\d+$/i.test(u) || /^M\d+$/i.test(u)){ primary.push(dict[u] || `未登録:${u}`); if(!dict[u]) unknowns.push(u); }
        else if (/^[XYZUWIJKRSPFQ][-+]?[\d\.]+$/i.test(u)){ params.push(u.toUpperCase()); }
        else if (/^N[\dA-Za-z]+$/i.test(u)){ primary.push(`ラベル ${u.toUpperCase()}`); }
        else if (/^IF$/i.test(u)){ primary.push("条件分岐 IF"); }
        else if (/^GOTO[\dA-Za-z]+$/i.test(u)){ primary.push(`GOTO ${u.slice(4).toUpperCase()}`); }
        else if (/^\#\d+$/i.test(u)){ params.push(u); }
        else if (/^(EQ|NE|GT|LT|GE|LE|\[|\]|AND|OR)$/.test(u)){ params.push(u); }
        else { unknowns.push(u); params.push(u); }
      }
      let name = primary.join(" ／ ");
      if (params.length){ const order="XYZUWIJKRSPFQ";
        const sorted = params.slice().sort((a,b)=>{ const ka=order.indexOf(a[0]); const kb=order.indexOf(b[0]);
          if(ka!==-1 && kb!==-1) return ka-kb; if(ka!==-1) return -1; if(kb!==-1) return 1; return a.localeCompare(b); });
        name += (name ? " " : "") + sorted.join(" ");
      }
      return [name, unknowns.length>0];
    }

    const selMaker = document.getElementById('maker');
    const selModel = document.getElementById('model');
    const selVersion = document.getElementById('version');
    const verLabel = document.getElementById('verLabel');
    const selSS = document.getElementById('subspindle');
    const ssLabel = document.getElementById('ssLabel');
    const dictListEl = document.getElementById('dictlist');

    function initSelectors(){
      selMaker.innerHTML = "";
      for (const m of MAKERS){
        const opt = document.createElement('option');
        opt.value = m.key; opt.textContent = m.name;
        selMaker.appendChild(opt);
      }
      updateModel();
    }

    function updateModel(){
      const maker = MAKERS.find(x => x.key === selMaker.value);
      selModel.innerHTML = "";
      for (const md of maker.models){
        const opt = document.createElement('option');
        opt.value = md.key; opt.textContent = md.name;
        selModel.appendChild(opt);
      }
      updateVersionAndSS();
    }

    function updateVersionAndSS(){
      const maker = MAKERS.find(x => x.key === selMaker.value);
      const model = maker.models.find(x => x.key === selModel.value);
      selVersion.innerHTML = "";
      if (model.versions && model.versions.length){
        verLabel.style.display = 'inline-block';
        for (const v of model.versions){
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = v;
          selVersion.appendChild(opt);
        }
      } else {
        verLabel.style.display = 'none';
      }
      ssLabel.style.display = model.subspindleOption ? 'inline-block' : 'none';
      renderDictList();
    }

    selMaker.addEventListener('change', updateModel);
    selModel.addEventListener('change', updateVersionAndSS);
    if (selVersion) selVersion.addEventListener('change', renderDictList);
    if (selSS) selSS.addEventListener('change', renderDictList);

    function currentKeysAndDict(){
      const makerKey = selMaker.value;
      const modelKey = selModel.value;
      const version = (verLabel.style.display !== 'none') ? selVersion.value : "";
      const ss = (ssLabel.style.display !== 'none') ? selSS.value : 'NoSS';
      const dict = composeDict(makerKey, modelKey, version, ss);
      const keys = Object.keys(dict);
      const g = keys.filter(k => /^G\d+$/.test(k)).sort((a,b)=>parseInt(a.slice(1))-parseInt(b.slice(1)));
      const m = keys.filter(k => /^M\d+$/.test(k)).sort((a,b)=>parseInt(a.slice(1))-parseInt(b.slice(1)));
      return {g, m, dict};
    }

    function renderDictList(){
      const {g, m, dict} = currentKeysAndDict();
      const rows = [];
      function section(title, arr){
        rows.push(`<tr><th colspan="2">${title}（${arr.length}件）</th></tr>`);
        for (const k of arr){
          rows.push(`<tr><td class="pill">${k}</td><td>${dict[k]}</td></tr>`);
        }
      }
      section('Gコード', g);
      section('Mコード', m);
      dictListEl.innerHTML = `<div class="small">※ 選択した機種で翻訳可能なコード名一覧。</div>
        <table>${rows.join('')}</table>`;
    }

    function currentDict(){
      const makerKey = selMaker.value;
      const modelKey = selModel.value;
      const version = (verLabel.style.display !== 'none') ? selVersion.value : "";
      const ss = (ssLabel.style.display !== 'none') ? selSS.value : 'NoSS';
      return composeDict(makerKey, modelKey, version, ss);
    }

    function render(){
      const dict = currentDict();
      const src = document.getElementById('src').value.replace(/\r\n/g,"\n");
      const out = document.getElementById('out'); out.innerHTML='';
      src.split('\n').forEach(line=>{
        const [name, hasUnknown] = translateLine(line, dict);
        const row = document.createElement('div'); row.className='row';
        const c1 = document.createElement('div'); c1.className='cell code'; c1.textContent = line;
        const c2 = document.createElement('div'); c2.className='cell tr'; c2.textContent = name;
        if (hasUnknown) c2.classList.add('unknown');
        row.appendChild(c1); row.appendChild(c2); out.appendChild(row);
      });
    }

    document.getElementById('btnTranslate').addEventListener('click', render);
    document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('src').value=''; document.getElementById('out').innerHTML=''; });
    document.getElementById('src').addEventListener('keydown', (e)=>{ if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { render(); } });

    // build tag
    document.title = document.title.replace('LITE-v5.1-20250828-002646', 'LITE-v5.1-20250828-002646');

    // init
    initSelectors();
    renderDictList();
  </script>
</body>
</html>
